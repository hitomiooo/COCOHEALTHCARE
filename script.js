// === Firebase SDK„É¢„Ç∏„É•„Éº„É´„Çí„Ç§„É≥„Éù„Éº„Éà ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
    getFirestore, collection, addDoc, getDocs, doc, 
    updateDoc, deleteDoc, query, orderBy, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
// ‚òÖ Ë™çË®º„É¢„Ç∏„É•„Éº„É´ (signInWithPopup)
import {
    getAuth,
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup, // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè
    signOut
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";


// === Firebase Ë®≠ÂÆö („Åì„Åì„ÅßÁΩÆ„ÅçÊèõ„Åà„Çã) ===
const firebaseConfig = {
  apiKey: "AIzaSyDCwPw3WxwYHvaudHqYJ64RzhS4hWhKvO0",
  authDomain: "coco-healthcare-59401.firebaseapp.com",
  projectId: "coco-healthcare-59401",
  storageBucket: "coco-healthcare-59401.firebasestorage.app",
  messagingSenderId: "986920233821",
  appId: "1:986920233821:web:96ff08e9f118d557a816b4"
    
};

// ‚òÖ‚òÖ‚òÖ=================================================‚òÖ‚òÖ‚òÖ
// ‚òÖ‚òÖ‚òÖ    „Åì„Åì„ÇíÁ∑®ÈõÜÔºÅ „Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åô„Çã‰∫∫„ÅÆ       ‚òÖ‚òÖ‚òÖ
// ‚òÖ‚òÖ‚òÖ    Google„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Çí„Ç´„É≥„Éû(,)Âå∫Âàá„Çä„ÅßÂÖ•Âäõ ‚òÖ‚òÖ‚òÖ
// ‚òÖ‚òÖ‚òÖ=================================================‚òÖ‚òÖ‚òÖ
const ALLOWED_EMAIL_LIST = [
    'fine2025contact@gmail.com',
    '1103ohtm@gmail.com',
    'tatsuya51801736@gmail.com'
];
// ‚òÖ‚òÖ‚òÖ=================================================‚òÖ‚òÖ‚òÖ


// === Firebase „ÅÆÂàùÊúüÂåñ ===
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); 
const recordsCollection = collection(db, 'records');

// === „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ===
let currentPhotoBase64 = null; // Base64ÊñáÂ≠óÂàó„Çí‰øùÊåÅ
let allRecordsCache = [];
let currentUser = null; 

// === HTMLË¶ÅÁ¥† ===
const mainContent = document.getElementById('mainContent');
const authSection = document.getElementById('authSection');
const authStatus = document.getElementById('authStatus');
const loginButton = document.getElementById('loginButton');
const logoutButton = document.getElementById('logoutButton');


// ‚òÖ‚òÖ‚òÖ Ë™çË®º„É≠„Ç∏„ÉÉ„ÇØ ‚òÖ‚òÖ‚òÖ

// „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÇíÁõ£Ë¶ñ„Åô„Çã
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        if (ALLOWED_EMAIL_LIST.includes(user.email)) {
            showApp(user);
        } else {
            showAccessDenied(user);
        }
    } else {
        currentUser = null;
        showLoginScreen();
    }
});

// „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ („Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÊñπÂºè)
loginButton.addEventListener('click', () => {
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider)
        .then((result) => {
            console.log("„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É≠„Ç∞„Ç§„É≥ÊàêÂäü:", result.user.email);
        })
        .catch((error) => {
            console.error("„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„É≠„Ç∞„Ç§„É≥Â§±Êïó:", error);
            if (error.code === 'auth/popup-closed-by-user') {
                alert("„É≠„Ç∞„Ç§„É≥„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü„ÄÇ");
            } else {
                alert("„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
            }
        });
});

// „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
logoutButton.addEventListener('click', () => {
    signOut(auth);
});

function showLoginScreen() {
    mainContent.style.display = 'none';
    authSection.style.display = 'block';
    authStatus.textContent = '„Ç¢„Éó„É™„Çí‰Ωø„ÅÜ„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    loginButton.style.display = 'block';
    logoutButton.style.display = 'none';
}
function showAccessDenied(user) {
    mainContent.style.display = 'none';
    authSection.style.display = 'block';
    authStatus.innerHTML = `„Çà„ÅÜ„Åì„Åù„ÄÅ ${user.displayName} „Åï„Çì<br><strong>(${user.email})</strong><br>„Åì„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅØ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ`;
    loginButton.style.display = 'none';
    logoutButton.style.display = 'block';
}
function showApp(user) {
    mainContent.style.display = 'block';
    authSection.style.display = 'block'; 
    authStatus.innerHTML = `„Çà„ÅÜ„Åì„Åù„ÄÅ ${user.displayName} „Åï„Çì<br><strong>(${user.email})</strong>`;
    loginButton.style.display = 'none';
    logoutButton.style.display = 'block';
    initializeAppLogic();
}

// ‚òÖ‚òÖ‚òÖ „Ç¢„Éó„É™Êú¨‰Ωì„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ ‚òÖ‚òÖ‚òÖ
let appInitialized = false;
function initializeAppLogic() {
    if (appInitialized) return;
    appInitialized = true;

    // „Éï„Ç©„Éº„É†„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    document.getElementById('healthForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('date').addEventListener('change', handleDateChange);
    document.getElementById('dogPhoto').addEventListener('change', handlePhotoPreview);
    document.getElementById('deleteButton').addEventListener('click', deleteCurrentRecord);
    
    // ‚òÖ „Çπ„Çø„É≥„ÉóÊ©üËÉΩ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä† ‚òÖ
    document.getElementById('stampPad').addEventListener('click', handleStampClick);

    const todayString = getFormattedDate(new Date());
    document.getElementById('date').value = todayString;
    loadAllRecordsFromFirestore();
}

function getFormattedDate(date) {
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}

function handleDateChange(event) {
    loadRecordForDate(event.target.value);
}

/**
 * ‚òÖ‚òÖ‚òÖ „Çπ„Çø„É≥„Éó„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„Åü„Å®„Åç„ÅÆÂá¶ÁêÜ ‚òÖ‚òÖ‚òÖ
 * („Åì„Åì„ÅåËøΩÂä†„Åï„Çå„ÅüÈñ¢Êï∞„Åß„Åô)
 */
function handleStampClick(event) {
    // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„ÅÆ„Åå .stamp-btn „ÇØ„É©„Çπ„ÅÆ„Éú„Çø„É≥„ÅãÁ¢∫Ë™ç
    if (event.target.classList.contains('stamp-btn')) {
        const stamp = event.target.textContent; // „Éú„Çø„É≥„ÅÆÁµµÊñáÂ≠ó„ÇíÂèñÂæó
        const memoTextArea = document.getElementById('otherNotes');
        
        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÁèæÂú®„ÅÆ„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÂèñÂæó
        const cursorPos = memoTextArea.selectionStart;
        const textBefore = memoTextArea.value.substring(0, cursorPos);
        const textAfter = memoTextArea.value.substring(cursorPos);
        
        // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Å´„Çπ„Çø„É≥„Éó„ÇíÊåøÂÖ•
        memoTextArea.value = textBefore + stamp + textAfter;
        
        // „Çπ„Çø„É≥„ÉóÊåøÂÖ•Âæå„Å´„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Çí„Çπ„Çø„É≥„Éó„ÅÆÁõ¥Âæå„Å´ÁßªÂãï
        const newPos = cursorPos + stamp.length;
        memoTextArea.selectionStart = newPos;
        memoTextArea.selectionEnd = newPos;
        
        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíÊàª„Åô
        memoTextArea.focus();
    }
}


/**
 * ÂÜôÁúü„Éó„É¨„Éì„É•„Éº (Base64„Å´Â§âÊèõ)
 */
async function handlePhotoPreview(event) {
    const file = event.target.files[0];
    const photoPreview = document.getElementById('photoPreview');
    
    if (file) {
        photoPreview.innerHTML = 'üîÑ ÂúßÁ∏Æ‰∏≠...';
        try {
            currentPhotoBase64 = await resizeAndEncode(file, 300, 0.4); 
            
            const img = document.createElement('img');
            img.src = currentPhotoBase64;
            photoPreview.innerHTML = '';
            photoPreview.appendChild(img);
        } catch (error) {
            console.error("ÂÜôÁúü„ÅÆÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº:", error);
            photoPreview.innerHTML = '‚ö†Ô∏è ÂÜôÁúü„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó';
            currentPhotoBase64 = null;
        }
    }
}

/**
 * „Éï„Ç©„Éº„É†ÈÄÅ‰ø° (Êñ∞È†ÖÁõÆÂØæÂøú)
 */
async function handleFormSubmit(event) {
    event.preventDefault(); 
    const saveButton = document.getElementById('saveButton');
    toggleLoading(true, '‰øùÂ≠ò‰∏≠...');

    try {
        const existingId = document.getElementById('recordId').value;
        const date = document.getElementById('date').value;

        let photoData = currentPhotoBase64;
        if (!photoData && existingId) {
            const existingRecord = allRecordsCache.find(r => r.id === existingId);
            if (existingRecord) {
                photoData = existingRecord.dogPhotoBase64 || null;
            }
        }

        const recordData = {
            date: date,
            weather: document.getElementById('weather').value,
            temperatureFeel: document.getElementById('temperatureFeel').value,
            conditionCoco: document.getElementById('conditionCoco').value,
            conditionNono: document.getElementById('conditionNono').value,
            conditionMomo: document.getElementById('conditionMomo').value,
            medPimo: document.getElementById('medPimo').checked,
            medLactu: document.getElementById('medLactu').checked,
            medConseve: document.getElementById('medConseve').checked,
            poopMorning: document.getElementById('poopMorning').checked,
            poopEvening: document.getElementById('poopEvening').checked,
            poopNight: document.getElementById('poopNight').checked,
            peeCount: document.getElementById('peeCount').value,
            peeColor: document.getElementById('peeColor').value,
            appetiteMorning: document.getElementById('appetiteMorning').value,
            appetiteNoon: document.getElementById('appetiteNoon').value,
            appetiteNight: document.getElementById('appetiteNight').value,
            sleepTime: document.getElementById('sleepTime').value,
            walk: document.getElementById('walk').value,
            otherNotes: document.getElementById('otherNotes').value,
            dogPhotoBase64: photoData,
            updatedAt: serverTimestamp(),
            ownerEmail: currentUser.email 
        };

        if (existingId) {
            const docRef = doc(db, 'records', existingId);
            await updateDoc(docRef, recordData);
        } else {
            const existingRecord = allRecordsCache.find(r => r.date === date);
            if (existingRecord) {
                alert("„Ç®„É©„Éº: „Åù„ÅÆÊó•‰ªò„ÅÆË®òÈå≤„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ„Éï„Ç©„Éº„É†„ÇíÊõ¥Êñ∞„Åó„Åæ„Åô„ÄÇ");
                loadRecordForDate(date);
                return;
            }
            await addDoc(recordsCollection, recordData);
        }
        
        alert("Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ");
        await loadAllRecordsFromFirestore();
        loadRecordForDate(date); 

    } catch (error) {
        console.error("‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:", error);
        alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
    } finally {
        toggleLoading(false);
    }
}

/**
 * Firestore„Åã„ÇâË™≠„ÅøËæº„Åø (Êñ∞È†ÖÁõÆÂØæÂøú„Ç¢„Ç≥„Éº„Éá„Ç£„Ç™„É≥)
 */
async function loadAllRecordsFromFirestore() {
    if (!currentUser) return; 

    const recordListDiv = document.getElementById('recordList');
    recordListDiv.innerHTML = '<p>üîÑ „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>';
    
    try {
        const q = query(recordsCollection, orderBy('date', 'desc'));
        const querySnapshot = await getDocs(q);
        
        allRecordsCache = []; 
        recordListDiv.innerHTML = ''; 

        if (querySnapshot.empty) {
            recordListDiv.innerHTML = '<p>„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
            return;
        }

        querySnapshot.forEach(doc => {
            const record = doc.data();
            const id = doc.id;
            
            allRecordsCache.push({ id, ...record });

            const recordItem = document.createElement('div');
            recordItem.className = 'record-item';

            const formattedDate = new Date(record.date).toLocaleDateString('ja-JP');
            
            let conditionStr = `„Ç≥„Ç≥:${record.conditionCoco || '‚óã'} | „Éé„Éé:${record.conditionNono || '‚óã'} | „É¢„É¢:${record.conditionMomo || '‚óã'}`;
            
            let poopStr = [
                record.poopMorning ? 'Êúù' : '',
                record.poopEvening ? 'Â§ï' : '',
                record.poopNight ? 'Â§ú' : ''
            ].filter(Boolean).join(', ') || '„Å™„Åó';

            let medStr = [
                record.medPimo ? '„Éî„É¢„Éô„Éè„Éº„Éà' : '',
                record.medLactu ? '„É©„ÇØ„ÉÑ„É≠„Éº„Çπ' : '',
                record.medConseve ? '„Ç≥„É≥„Çª„Éº„Éñ' : ''
            ].filter(Boolean).join(', ') || '„Å™„Åó';

            recordItem.innerHTML = `
                <div class="record-header">
                    <h4>${formattedDate} ${record.weather} (‰ΩìÊÑü:${record.temperatureFeel || '?'})</h4>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="record-body">
                    <p><strong>‰ΩìË™ø:</strong> ${conditionStr}</p>
                    <p><strong>„ÅäÈÄö„Åò:</strong> ${poopStr}</p>
                    <p><strong>ÊúçÁî®Ëñ¨:</strong> ${medStr}</p>
                    <hr>
                    <p><strong>„Åä„Åó„Å£„Åì:</strong> ${record.peeCount}Âõû (${record.peeColor})</p>
                    <p><strong>È£üÊ¨≤:</strong> Êúù:${record.appetiteMorning} Êòº:${record.appetiteNoon} Êô©:${record.appetiteNight}</p>
                    <p><strong>Áù°Áú†:</strong> ${record.sleepTime}</p>
                    <p><strong>Êï£Ê≠©:</strong> ${record.walk}</p>
                    ${record.otherNotes ? `<p><strong>„É°„É¢:</strong> ${record.otherNotes.replace(/\n/g, '<br>')}</p>` : ''}
                    ${record.dogPhotoBase64 ? `<div class="record-photo"><img src="${record.dogPhotoBase64}" alt="„Çè„Çì„Åì"></div>` : ''}
                    <button class="edit-btn-small">„Åì„ÅÆÊó•„ÇíÁ∑®ÈõÜ„Åô„Çã</button>
                </div>
            `;
            
            const header = recordItem.querySelector('.record-header');
            const body = recordItem.querySelector('.record-body');
            const icon = recordItem.querySelector('.toggle-icon');
            
            header.onclick = () => {
                const isHidden = body.style.display === 'none' || body.style.display === '';
                if (isHidden) {
                    body.style.display = 'block';
                    icon.textContent = '‚ñ≤';
                } else {
                    body.style.display = 'none';
                    icon.textContent = '‚ñº';
                }
            };
            
            const editButton = recordItem.querySelector('.edit-btn-small');
            editButton.onclick = (e) => {
                e.stopPropagation(); 
                loadRecordById(id);
            };

            recordListDiv.appendChild(recordItem);
        });
        
        const todayString = document.getElementById('date').value;
        loadRecordForDate(todayString);

    } catch (error) {
        console.error("„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", error);
        recordListDiv.innerHTML = '<p>‚ö†Ô∏è „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</p>';
    }
}


function loadRecordForDate(dateString) {
    const record = allRecordsCache.find(r => r.date === dateString);
    if (record) {
        populateForm(record);
        document.getElementById('saveButton').textContent = 'Ë®òÈå≤„ÇíÊõ¥Êñ∞„Åô„Çã';
        document.getElementById('deleteButton').style.display = 'block';
    } else {
        clearForm(dateString); 
        document.getElementById('saveButton').textContent = 'Ë®òÈå≤„Åô„Çã';
        document.getElementById('deleteButton').style.display = 'none';
    }
}

function loadRecordById(id) {
    const record = allRecordsCache.find(r => r.id === id);
    if (record) {
        document.getElementById('date').value = record.date; 
        populateForm(record);
        document.getElementById('saveButton').textContent = 'Ë®òÈå≤„ÇíÊõ¥Êñ∞„Åô„Çã';
        document.getElementById('deleteButton').style.display = 'block';
        window.scrollTo(0, 0); // „Éö„Éº„Ç∏‰∏äÈÉ®„ÅÆ„Éï„Ç©„Éº„É†„Å´„Çπ„ÇØ„É≠„Éº„É´
    }
}

/**
 * „Éï„Ç©„Éº„É†ÂÖ•Âäõ (Êñ∞È†ÖÁõÆÂØæÂøú)
 */
function populateForm(record) {
    document.getElementById('healthForm').reset();
    document.getElementById('recordId').value = record.id;
    document.getElementById('date').value = record.date;
    document.getElementById('weather').value = record.weather;
    
    document.getElementById('temperatureFeel').value = record.temperatureFeel || '„Å°„Çá„ÅÜ„Å©„ÅÑ„ÅÑ';
    document.getElementById('conditionCoco').value = record.conditionCoco || '‚óã';
    document.getElementById('conditionNono').value = record.conditionNono || '‚óã';
    document.getElementById('conditionMomo').value = record.conditionMomo || '‚óã';
    
    document.getElementById('medPimo').checked = record.medPimo === true;
    document.getElementById('medLactu').checked = record.medLactu === true;
    document.getElementById('medConseve').checked = record.medConseve === true;
    
    document.getElementById('poopMorning').checked = record.poopMorning === true;
    document.getElementById('poopEvening').checked = record.poopEvening === true;
    document.getElementById('poopNight').checked = record.poopNight === true;

    document.getElementById('peeCount').value = record.peeCount || 0;
    document.getElementById('peeColor').value = record.peeColor || 'ÊôÆÈÄö';
    document.getElementById('appetiteMorning').value = record.appetiteMorning || 'ÂÆåÈ£ü';
    document.getElementById('appetiteNoon').value = record.appetiteNoon || 'ÂÆåÈ£ü';
    document.getElementById('appetiteNight').value = record.appetiteNight || 'ÂÆåÈ£ü';
    document.getElementById('sleepTime').value = record.sleepTime || '„Åö„Å£„Å®ÂØù„Å¶„Çã';
    document.getElementById('walk').value = record.walk || 'Ë°å„Å£„Å¶„Å™„ÅÑ';
    document.getElementById('otherNotes').value = record.otherNotes || '';

    currentPhotoBase64 = null; 
    const photoPreview = document.getElementById('photoPreview');
    photoPreview.innerHTML = '';
    if (record.dogPhotoBase64) {
        const img = document.createElement('img');
        img.src = record.dogPhotoBase64;
        photoPreview.appendChild(img);
    }
    document.getElementById('dogPhoto').value = ""; 
}

/**
 * „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢ (Êñ∞È†ÖÁõÆÂØæÂøú)
 */
function clearForm(dateString) {
    document.getElementById('healthForm').reset(); 
    document.getElementById('recordId').value = '';
    document.getElementById('date').value = dateString; 
    
    currentPhotoBase64 = null;
    document.getElementById('photoPreview').innerHTML = '';
    
    document.getElementById('temperatureFeel').value = '„Å°„Çá„ÅÜ„Å©„ÅÑ„ÅÑ';
    document.getElementById('conditionCoco').value = '‚óã';
    document.getElementById('conditionNono').value = '‚óã';
    document.getElementById('conditionMomo').value = '‚óã';
    document.getElementById('sleepTime').value = '„Åö„Å£„Å®ÂØù„Å¶„Çã';
    
    document.getElementById('medPimo').checked = true;
    document.getElementById('medLactu').checked = true;
    document.getElementById('medConseve').checked = true;
    
    document.getElementById('poopMorning').checked = false;
    document.getElementById('poopEvening').checked = false;
    document.getElementById('poopNight').checked = false;

    document.getElementById('peeCount').value = 0;
    document.getElementById('peeColor').value = 'ÊôÆÈÄö';
    document.getElementById('appetiteMorning').value = 'ÂÆåÈ£ü';
    document.getElementById('appetiteNoon').value = 'ÂÆåÈ£ü';
    document.getElementById('appetiteNight').value = 'ÂÆåÈ£ü';
    document.getElementById('walk').value = 'Ë°å„Å£„Å¶„Å™„ÅÑ';
    document.getElementById('otherNotes').value = '';
}

/**
 * ÂâäÈô§ (Firestore„ÅÆ„Åø)
 */
async function deleteCurrentRecord() {
    const idToDelete = document.getElementById('recordId').value;
    if (!idToDelete) {
        alert("ÂâäÈô§„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
        return;
    }
    if (!confirm('Êú¨ÂΩì„Å´„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
        return; 
    }
    toggleLoading(true, 'ÂâäÈô§‰∏≠...');

    try {
        const docRef = doc(db, 'records', idToDelete);
        await deleteDoc(docRef);

        alert("Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ");
        
        await loadAllRecordsFromFirestore();
        const todayString = getFormattedDate(new Date());
        document.getElementById('date').value = todayString;
        loadRecordForDate(todayString); 

    } catch (error) {
        console.error("ÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº:", error);
        alert("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
    } finally {
        toggleLoading(false);
    }
}

/**
 * „Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà
 */
function toggleLoading(isLoading, buttonText = null) {
    const saveButton = document.getElementById('saveButton');
    const deleteButton = document.getElementById('deleteButton');
    saveButton.disabled = isLoading;
    deleteButton.disabled = isLoading;
    if (buttonText) {
        saveButton.textContent = buttonText;
    } else {
        const existingId = document.getElementById('recordId').value;
        saveButton.textContent = existingId ? 'Ë®òÈå≤„ÇíÊõ¥Êñ∞„Åô„Çã' : 'Ë®òÈå≤„Åô„Çã';
    }
}

/**
 * ÂúßÁ∏ÆÈñ¢Êï∞ (Base64„ÇíËøî„Åô)
 */
function resizeAndEncode(file, maxSize = 300, quality = 0.4) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Base64ÊñáÂ≠óÂàó„ÇíËøî„Åô
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
            };
            img.onerror = reject;
            img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}
